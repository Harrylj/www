<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>聊天界面</title>
		<link href="./css/mui.min.css" rel="stylesheet" />
		<link href="./css/mui.imageviewer.css" rel="stylesheet" />

		<!--App自定义的css-->
		<link rel="stylesheet" type="text/css" href="css/public.css" />
		<link rel="stylesheet" type="text/css" href="css/chat.css" />
		<style>

		</style>
	</head>

	<body contextmenu="return false;">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title" id="title">(聊天窗口)</h1>
			<a class="mui-icon mui-icon-phone mui-pull-right" id="telephone" href="tel:10086"></a>
		</header>
		<pre id='h'></pre>
		<div class="mui-content">
			<!--<div id='msg-list'></div>-->
			<div class="chat-header">
				<ul class="ch-ul">
					<li class="ch-li-repair">维修</li>
					<li class="ch-li-water">送水</li>
					<li class="ch-li-money">缴费</li>
					<li class="ch-li-call">呼叫</li>
					<li class="ch-li-complaint">投诉</li>
				</ul>
			</div>
			<div class="chatBox-content">
				<div class="chatBox-content-demo" id="chatBox-content-demo">

					<div class="clearfloat">
						<div class="author-name">
							<small class="chat-date">2017-12-02 14:26:58</small>
						</div>
						<div class="left">
							<div class="chat-avatars"><img src="images/chat/icon01.png" alt="头像" /></div>
							<div class="chat-message">
								给你看张图
							</div>
						</div>
					</div>

					<div class="clearfloat">
						<div class="author-name">
							<small class="chat-date">2017-12-02 14:26:58</small>
						</div>
						<div class="left">
							<div class="chat-avatars"><img src="images/chat/icon01.png" alt="头像" /></div>
							<div class="chat-message">
								<img src="images/chat/1.png" alt="">
							</div>
						</div>
					</div>

					<div class="clearfloat">
						<div class="author-name">
							<small class="chat-date">2017-12-02 14:26:58</small>
						</div>
						<div class="right">
							<div class="chat-message">好看！</div>
							<div class="chat-avatars"><img src="images/chat/icon02.png" alt="头像" /></div>
						</div>
					</div>

				</div>
			</div>
		</div>
		<footer>

			<label class="footer-left" id="chat-tuxiang" title="发送图片" for="inputImage" class="btn-default-styles">
                            <input type="file" onchange="selectImg(this)" accept="image/jpg,image/jpeg,image/png"
                                   name="file" id="inputImage" class="hidden">
                            <i id='msg-image' class="mui-icon mui-icon-camera" style="font-size: 28px;"></i>
                        </label>
			<div class="footer-center">
				<textarea id='msg-text' type="text" class='input-text div-textarea'></textarea>
				<button id='msg-sound' type="button" class='input-sound' style="display: none;">按住说话</button>
			</div>
			<label for="" class="footer-right">
			  <button class="chat-btn-fs">发送</button>
				<!--<i id='msg-type' class="mui-icon mui-icon-mic"></i>-->
			</label>
		</footer>
		<div id='sound-alert' class="rprogress">
			<div class="rschedule"></div>
			<div class="r-sigh">!</div>
			<div id="audio_tips" class="rsalert">手指上滑，取消发送</div>
		</div>
		<script src="js/mui.min.js" type="text/javascript"></script>
		<script src="js/mui.imageViewer.js"></script>
		<script src="js/jquery-1.12.4.min.js"></script>
		<script src="js/chat/jquery.signalR-2.2.0.min.js"></script>
		<script src="js/chat/chat.js"></script>
		<script type="text/javascript" charset="utf-8">
			//      发送图片
			function selectImg(pic) {
				if(!pic.files || !pic.files[0]) {
					return;
				}
				var reader = new FileReader();
				// 用户id
					var user_id = '3222a169-cdab-4e3a-bba9-124676f64668';
					var myDate = new Date();
					var abc = myDate.getFullYear() + '-' + myDate.getMonth() + '-' + myDate.getDate() + ' ' + myDate.getHours() + ':' + myDate.getMinutes() + ':' + myDate.getSeconds();
					// 时间
					var user_time = abc;
					
				reader.onload = function(evt) {
					var images = evt.target.result;
					$(".chatBox-content-demo").append("<div class=\"clearfloat\">" +
						"<div class=\"author-name\"><small class=\"chat-date\">" + user_time +"</small> </div> " +
						"<div class=\"right\"> <div class=\"chat-message\"><img src=" + images + "></div> " +
						"<div class=\"chat-avatars\"><img src=\"images/chat/icon01.png\" alt=\"头像\" /></div> </div> </div>");
					//聊天框默认最底部
					$(document).ready(function() {
						$("#chatBox-content-demo").scrollTop($("#chatBox-content-demo")[0].scrollHeight);
					});
					
					chatManager.im.sendMsg(user_id, images, 0);
				};
				reader.readAsDataURL(pic.files[0]);

			}

			(function(doc) {
				var MIN_SOUND_TIME = 800;
				mui.init({
					gestureConfig: {
						tap: true, //默认为true
						doubletap: true, //默认为false
						longtap: true, //默认为false
						swipe: true, //默认为true
						drag: true, //默认为true
						hold: true, //默认为false，不监听
						release: true //默认为false，不监听
					}
				});

				if(mui.os.ios) {
					// 解决在ios上fixed元素focusin时位置出现错误的问题 
					document.addEventListener('DOMContentLoaded', function() {
						var footerDom = document.querySelector('footer');

						document.addEventListener('focusin', function() {
							footerDom.style.position = 'absolute';
						});
						document.addEventListener('focusout', function() {
							footerDom.style.position = 'fixed';
						});
					});
				}
				/*
				// 初始化 连接服务器    -回调是收消息的方法,用户id,消息,发送时间，
				chatManager.im.init("cdsdtz", function(userId, msg, dateTime, isSystem){
				  console.log(msg)
				});
        
				// chat_发送消息
				chatManager.im.sendMsg(event.detail.revId, event.detail.msg, event.detail.isSystem);
				*/

				// 初始化 连接服务器    -回调是收消息的方法,用户id,消息,发送时间，
				chatManager.im.init("cdsdtz", function(userId, msg, dateTime, isSystem) {
					var chat_content = `<div class="clearfloat">
                            <div class="author-name">
                                <small class="chat-date">${dateTime}</small>
                            </div>
                            <div class="left">
                                <div class="chat-avatars"><img src="images/chat/icon01.png" alt="头像"/></div>
                                <div class="chat-message">
                                    ${msg}
                                </div>
                            </div>
                        </div>`;

					$('.chatBox-content-demo').append(chat_content);

					console.log(msg)
				});

				// 点击发送按钮
				$('.chat-btn-fs').on('click', function() {
					//var textContent = $(".div-textarea").html().replace(/[\n\r]/g, '<br>')
					var textContent = $(".div-textarea").val().replace(/[\n\r]/g, '<br>');
					// 用户id
					var user_id = '3222a169-cdab-4e3a-bba9-124676f64668';
					var myDate = new Date();
					var abc = myDate.getFullYear() + '-' + myDate.getMonth() + '-' + myDate.getDate() + ' ' + myDate.getHours() + ':' + myDate.getMinutes() + ':' + myDate.getSeconds();
					// 时间
					var user_time = abc;

					if(textContent != "") {
						$(".chatBox-content-demo").append("<div class=\"clearfloat\">" +
							"<div class=\"author-name\"><small class=\"chat-date\">" + user_time + "</small> </div> " +
							"<div class=\"right\"> <div class=\"chat-message\"> " + textContent + " </div> " +
							"<div class=\"chat-avatars\"><img src=\"images/chat/icon02.png\" alt=\"头像\" /></div> </div> </div>");
						//发送后清空输入框
						$(".div-textarea").val("");
						//聊天框默认最底部
						$(document).ready(function() {
							$("#chatBox-content-demo").scrollTop($("#chatBox-content-demo")[0].scrollHeight);
						});
						// 发送消息
						chatManager.im.sendMsg(user_id, textContent, 0);
						console.log(textContent)
					}
				})
			

				// 点击菜单，维修，送水，缴费，呼叫，投诉
				$('.ch-ul').children('li').on('click',function(){
					var this_html = $(this).html()
					alert(this_html + ' 功能正在开发中')
				})
				
				/*
				dd.httpRequest({
				  url: "http://api.cdrenju.com/sdtz/adms/im/send",
				  method: "POST",
				  data: {
				    loginMark: myInfo.loginMark,
				    token: myInfo.token,
				    data: JSON.stringify({
				      userId: otherUser.userId,
				      content: message
				    })
				  },
				  success: function(res) {
				    console.log("sendMessage success:" + JSON.stringify(res));
				  },
				  fail: function(res) {
				    console.log("sendMessage fail:" + JSON.stringify(res));
				  },
				});
				*/

			}(document));
		</script>
	</body>

</html>